#
# @configure_input@
#

# This Makefile makes everything in the BBS.

#BBSSRC		= /usr/local/bbs/src
SRCLIB		= $(BBSSRC)/LIB
MYNAME		= $(BBSSRC)/Makefile
SHELL		= bash
CONFIG		= CONFIG/Make.config
NEEDTYPHOON	= $(shell ./needtyphoon)
DISTRIBUTION	= distbin
DISTDIR		= dist
DISTNAME	= megistos
DISTVER		= $(MAJORVERSION).$(MINORVERSION).$(PATCH)
MKLSM		= lsm/mklsm.sh $(MAJORVERSION) $(MINORVERSION) $(PATCH)

include $(CONFIG)
include .dirdep
include .rcsdep

.dummy: all dep depend clean .dirdep

all:		.dirdep
		@$(SHOWSTATUS) PROCEEDING TO MAKE ALL SUBSYSTEMS.
		set -e; for i in $(SUBDIRS); do $(MAKE) -C $$i; done

depend dep:	.dirdep .rcsdep
		@$(SHOWSTATUS) PROCEEDING TO MAKE ALL SUBSYSTEM DEPENDENCIES.
		@set -e; for i in $(SUBDIRS); do $(MAKE) -C $$i dep; done

distclean:	clean
		@$(SHOWSTATUS) CLEANING UP A LOT.
		$(RM) -f config.{cache,log,status} libtool makefile $(CONFIG)
		$(RM) .dirdep *~ #*# DEADJOE
		$(RM) `find . -name '*~' -o -name '#*#' -o -name core -o -name .depend -o -name DEADJOE`
		$(RM) CONFIG/{Make.config,Make.RCS,bbsconfig.defs.h,*~}

clean:		.dirdep
		@$(SHOWSTATUS) PROCEEDING TO CLEAN UP ALL SUBDIRS.
		$(RM) -f .dirdep
		@set -e; for i in $(SUBDIRS); do $(MAKE) -C $$i clean; done

ci:           
		CVS_RSH=ssh \
		cvs -z9 -d:ext:alexios@cvs.megistos.sourceforge.net:/cvsroot/megistos commit

co:           
		CVS_RSH=ssh \
		cvs -z9 -d:ext:alexios@cvs.megistos.sourceforge.net:/cvsroot/megistos update

#ci:		.rcsdep
#		@$(SHOWSTATUS) RCS CHECKING IN ALL SOURCE CODE.
#		@set -e; for i in $(RCSSUBDIRS); do $(MAKE) -C $$i ci; done

#co:		.rcsdep
#		@$(SHOWSTATUS) CHECKING OUT ALL SOURCE CODE.
#		@set -e; for i in $(RCSSUBDIRS); do $(MAKE) -C $$i co; done

.dirdep:
		@$(SHOWSTATUS) LOCATING SUBDIRECTORIES.
ifeq ($(NEEDTYPHOON),1)
		find $(BBSSRC) -type d -follow -print 2>/dev/null|\
		fgrep -xv $(BBSSRC)|sort >.a
else
		@$(SHOWSTATUS) LOCATING SUBDIRECTORIES.
		find $(BBSSRC) -type d -follow -print 2>/dev/null|\
		fgrep -xv $(BBSSRC)|fgrep -v $(BBSSRC)/TYPHOON|sort >.a
endif
		echo $(SRCLIB) >.b
		fgrep -v $(SRCLIB) .a |fgrep -v virgin|fgrep -v dist >>.b
		echo 'SUBDIRS=\' >.c;
		for i in `sed <.b 's/^$(subst /,\/,$(BBSSRC)/)//'`; do\
			if (test -e $$i/Makefile) then echo $$i'\' >>.c; fi;\
		done
		rm -f .a .b
		mv .c .dirdep

.rcsdep:
		@$(SHOWSTATUS) LOCATING RCS SUBDIRECTORIES.
		find $(BBSSRC) -type d -follow -print 2>/dev/null|\
		fgrep -xv $(BBSSRC)|sort >.a
		echo $(SRCLIB) >.b
		fgrep -v $(SRCLIB) .a >>.b
		echo 'RCSSUBDIRS=\' >.c;
		for i in `sed <.b 's/^$(subst /,\/,$(BBSSRC)/)//'`; do\
			if (test -e $$i/RCS) then echo $$i'\' >>.c; fi;\
		done
		rm -f .a .b
		mv .c .rcsdep

.PHONY:		all depend dep distclean clean ci co

#
# Distribution files
#

.PHONY:		dist distsec distsecurity distsrc distbin

dist:		distsrc distmsgs distbin distbase distsecurity

distsec \
distsecurity:
		@$(SHOWSTATUS) SIGNING DISTRIBUTION FILES
		gpg -a --export Megistos >$(DISTDIR)/MEGISTOS-GPG-PUBLIC-KEY
		cd $(DISTDIR); for a in *.gz *.bz2; do gpg -asb $$a; done
		cd $(DISTDIR); md5sum *.gz *.bz2 |sort -k2 >MD5SUMS

distsrc:	
		@$(SHOWSTATUS) MAKING SOURCE DISTRIBUTION UPDATE.
		$(RM) $(DISTDIR)/$(DISTNAME)_src-$(DISTVER).*
		$(RM) -rf $(DISTDIR)/$(DISTNAME) $(DISTDIR)/$(DISTNAME)_src-$(DISTVER).*asc
		mkdir $(DISTDIR)/$(DISTNAME)
		$(CHMOD) 0750 $(DISTDIR)/$(DISTNAME)
		cd ..; find src -mindepth 1 -maxdepth 1|grep -v /dist >/tmp/distsrc
		umask 000; (cd ..; $(TAR) -T /tmp/distsrc -cf -)|(cd $(DISTDIR)/$(DISTNAME);$(TAR) -xvf -)
		$(RM) /tmp/distsrc
		find $(DISTDIR)/$(DISTNAME) \
			-name 'version.mk' \
			-or -name '*.msg' \
			-or -name '*~' \
			-or -name '*.[oa]' \
			-or -name '*.lo' \
			-or -name core \
			-or -name .depend \
			-or -name makefile \
			-or -name config.log \
			-or -name config.cache | xargs rm
		cd $(DISTDIR); $(TAR) cvf $(DISTNAME)_src-$(DISTVER).tar $(DISTNAME)
		cd $(DISTDIR); $(GZIP) -9v <$(DISTNAME)_src-$(DISTVER).tar >$(DISTNAME)_src-$(DISTVER).tar.gz
		cd $(DISTDIR); $(BZIP2) -9v $(DISTNAME)_src-$(DISTVER).tar
		$(RM) -rf $(DISTDIR)/$(DISTNAME)
		$(MKLSM) src >$(DISTDIR)/$(DISTNAME)_src-$(DISTVER).lsm
		$(CP) ../COPYING 0* $(DISTDIR)

distmsgs:	
		@$(SHOWSTATUS) MAKING MESSAGE BLOCK DISTRIBUTION UPDATE.
		$(RM) $(DISTDIR)/$(DISTNAME)_msgs-$(DISTVER).*
		$(RM) -rf $(DISTDIR)/$(DISTNAME) $(DISTDIR)/$(DISTNAME)_msgs-$(DISTVER).*asc
		mkdir $(DISTDIR)/$(DISTNAME)
		$(CHMOD) 0750 $(DISTDIR)/$(DISTNAME)
		cd ..;find -type f -name '*.msg*' >/tmp/distsrc
		umask 000; (cd ..;$(TAR) -T/tmp/distsrc -cf -)|(cd $(DISTDIR)/$(DISTNAME);$(TAR) -xvf -)
		$(RM) /tmp/distsrc
		cd $(DISTDIR)/$(DISTNAME); for a in `find -name '*.msg.orig'`; do \
			mv -v $$a `echo $$a|sed 's/.orig$$//'`; done
		cd $(DISTDIR); $(TAR) cvf $(DISTNAME)_msgs-$(DISTVER).tar $(DISTNAME)
		cd $(DISTDIR); $(GZIP) -9v <$(DISTNAME)_msgs-$(DISTVER).tar >$(DISTNAME)_msgs-$(DISTVER).tar.gz
		cd $(DISTDIR); $(BZIP2) -9v $(DISTNAME)_msgs-$(DISTVER).tar
		$(RM) -rf $(DISTDIR)/$(DISTNAME)
		$(MKLSM) msgs >$(DISTDIR)/$(DISTNAME)_msgs-$(DISTVER).lsm
		$(CP) ../COPYING 0* $(DISTDIR)

distbin:
		@$(SHOWSTATUS) MAKING BINARY DISTRIBUTION UPDATE.
		$(RM) $(DISTDIR)/$(DISTNAME)_bin-$(DISTVER).*
		$(RM) -rf $(DISTDIR)/$(DISTNAME) $(DISTDIR)/$(DISTNAME)_bin-$(DISTVER).*asc
		mkdir $(DISTDIR)/$(DISTNAME)
		$(CHMOD) 0750 $(DISTDIR)/$(DISTNAME)
		umask 000; $(CP) -rv ../bin ../lib $(DISTDIR)/$(DISTNAME)
		$(STRIP) $(DISTDIR)/$(DISTNAME)/bin/* 2>/dev/null || true
		$(RM) $(DISTDIR)/$(DISTNAME)/lib/prompts/*
		cd $(DISTDIR); $(TAR) cvf $(DISTNAME)_bin-$(DISTVER).tar $(DISTNAME)
		cd $(DISTDIR); $(GZIP) -9v <$(DISTNAME)_bin-$(DISTVER).tar >$(DISTNAME)_bin-$(DISTVER).tar.gz
		cd $(DISTDIR); $(BZIP2) -9v $(DISTNAME)_bin-$(DISTVER).tar
		$(RM) -rf $(DISTDIR)/$(DISTNAME)
		$(MKLSM) bin >$(DISTDIR)/$(DISTNAME)_bin-$(DISTVER).lsm
		$(CP) ../COPYING 0* $(DISTDIR)

distbase:	
		@$(SHOWSTATUS) MAKING BINARY DISTRIBUTION UPDATE.
		$(RM) $(DISTDIR)/$(DISTNAME)_base-$(DISTVER).*
		$(RM) -rf $(DISTDIR)/$(DISTNAME) $(DISTDIR)/$(DISTNAME)_base-$(DISTVER).*asc
		mkdir $(DISTDIR)/$(DISTNAME)
		$(CP) ../COPYING 0* $(DISTDIR)/$(DISTNAME)/
		$(CHMOD) 644 $(DISTDIR)/$(DISTNAME)/COPYING
		for a in bin data doc etc home lib lock log src; do \
			mkdir $(DISTDIR)/$(DISTNAME)/$$a; \
			$(CHMOD) 770 $(DISTDIR)/$(DISTNAME)/$$a; \
		done
		$(CHMOD) 700 $(DISTDIR)/$(DISTNAME)/src
		cd virgin; umask 000; $(CP) -rv . ../$(DISTDIR)/$(DISTNAME)
		cd $(DISTDIR); $(TAR) cvf $(DISTNAME)_base-$(DISTVER).tar $(DISTNAME)
		cd $(DISTDIR); $(GZIP) -9v <$(DISTNAME)_base-$(DISTVER).tar >$(DISTNAME)_base-$(DISTVER).tar.gz
		cd $(DISTDIR); $(BZIP2) -9v $(DISTNAME)_base-$(DISTVER).tar
		$(RM) -rf $(DISTDIR)/$(DISTNAME)
		$(MKLSM) base >$(DISTDIR)/$(DISTNAME)_base-$(DISTVER).lsm
		$(CP) ../COPYING 0* $(DISTDIR)
