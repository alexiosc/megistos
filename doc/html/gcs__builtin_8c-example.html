<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Megistos API: Example Documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>gcs_builtin.c</h1>A very long example demonstrating how to write global commands. This file implements the builtin global commands for this system. It serves as an example of numerous BBS methods. <div class="fragment"><pre><span class="comment">/*****************************************************************************\</span>
<span class="comment"> **                                                                         **</span>
<span class="comment"> **  FILE:     gcs_builtin.c                                                **</span>
<span class="comment"> **  AUTHORS:  Alexios                                                      **</span>
<span class="comment"> **  PURPOSE:  A few built-in global commands.                              **</span>
<span class="comment"> **  NOTES:                                                                 **</span>
<span class="comment"> **  LEGALESE:                                                              **</span>
<span class="comment"> **                                                                         **</span>
<span class="comment"> **  This program is free software; you  can redistribute it and/or modify  **</span>
<span class="comment"> **  it under the terms of the GNU  General Public License as published by  **</span>
<span class="comment"> **  the Free Software Foundation; either version 2 of the License, or (at  **</span>
<span class="comment"> **  your option) any later version.                                        **</span>
<span class="comment"> **                                                                         **</span>
<span class="comment"> **  This program is distributed  in the hope  that it will be useful, but  **</span>
<span class="comment"> **  WITHOUT    ANY WARRANTY;   without  even  the    implied warranty  of  **</span>
<span class="comment"> **  MERCHANTABILITY or  FITNESS FOR  A PARTICULAR  PURPOSE.   See the GNU  **</span>
<span class="comment"> **  General Public License for more details.                               **</span>
<span class="comment"> **                                                                         **</span>
<span class="comment"> **  You  should have received a copy   of the GNU  General Public License  **</span>
<span class="comment"> **  along with    this program;  if   not, write  to  the   Free Software  **</span>
<span class="comment"> **  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.              **</span>
<span class="comment">\*****************************************************************************/</span>


<span class="comment">/*</span>
<span class="comment"> * $Id: gcs_builtin.c,v 1.6 2003/09/28 11:40:07 alexios Exp $</span>
<span class="comment"> *</span>
<span class="comment"> * $Log: gcs_builtin.c,v $</span>
<span class="comment"> * Revision 1.6  2003/09/28 11:40:07  alexios</span>
<span class="comment"> * Ran indent(1) on all C source to improve readability.</span>
<span class="comment"> *</span>
<span class="comment"> * Revision 1.5  2003/09/27 20:33:12  alexios</span>
<span class="comment"> * Aesthetic fixes (indentations, spacing, etc).</span>
<span class="comment"> *</span>
<span class="comment"> * Revision 1.4  2003/08/15 18:08:45  alexios</span>
<span class="comment"> * Rationalised RCS/CVS ident(1) strings.</span>
<span class="comment"> *</span>
<span class="comment"> * Revision 1.3  2001/04/22 14:49:04  alexios</span>
<span class="comment"> * Merged in leftover 0.99.2 changes and additional bug fixes.</span>
<span class="comment"> *</span>
<span class="comment"> *</span>
<span class="comment"> */</span>


<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> rcsinfo[] =
    <span class="stringliteral">"$Id: gcs_builtin.c,v 1.6 2003/09/28 11:40:07 alexios Exp $"</span>;


<span class="preprocessor">#define WANT_STDIO_H 1</span>
<span class="preprocessor"></span><span class="preprocessor">#define WANT_STDLIB_H 1</span>
<span class="preprocessor"></span><span class="preprocessor">#define WANT_UNISTD_H 1</span>
<span class="preprocessor"></span><span class="preprocessor">#define WANT_STRINGS_H 1</span>
<span class="preprocessor"></span><span class="preprocessor">#define WANT_DIRENT_H 1</span>
<span class="preprocessor"></span><span class="preprocessor">#define WANT_SYS_STAT_H 1</span>
<span class="preprocessor"></span><span class="preprocessor">#define WANT_SYS_SHM_H 1</span>
<span class="preprocessor"></span><span class="preprocessor">#define WANT_TIME_H 1</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="bbsinclude_8h.html">bbsinclude.h</a>&gt;</span>

<span class="preprocessor">#include &lt;<a class="code" href="bbs_8h.html">bbs.h</a>&gt;</span>

<span class="preprocessor">#include "mbk_sysvar.h"</span>

<span class="preprocessor">#define USERPAGED (othruseronl.onlinetime-othruseronl.lastpage \</span>
<span class="preprocessor">                   &lt;othruseracc.pagetime)</span>
<span class="preprocessor"></span><span class="preprocessor">#define ISYSOP    (hassysaxs(&amp;thisuseracc,USY_MASTERKEY))</span>
<span class="preprocessor"></span>

<span class="comment">/* Print out the current date and time. */</span>

<span class="keyword">static</span> <span class="keywordtype">int</span>
gcs_time ()
{
        <span class="keywordtype">long</span>    date, time;
        <span class="keywordtype">char</span>    month[64];

        <span class="keywordflow">if</span> (!<a class="code" href="group__input.html#a4">margc</a>)
                <span class="keywordflow">return</span> 0;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="group__input.html#a4">margc</a> == 1) &amp;&amp;
                 (<a name="a0"></a><a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/time"</span>) || <a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/t"</span>))) {

                date = <a name="a1"></a><a class="code" href="timedate_8h.html#a12">today</a> ();
                time = <a name="a2"></a><a class="code" href="timedate_8h.html#a13">now</a> ();
                <a name="a3"></a><a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);
                strcpy (month, msg_string (tdmonth (date) + DTCJAN));
                <a name="a4"></a><a class="code" href="group__output.html#a7">prompt</a> (TIME,
                        tdday (date),
                        month, tdyear (date), strtime (now (), 1));
                <a name="a5"></a><a class="code" href="group__prompts.html#a9">msg_reset</a> ();

                <span class="keywordflow">return</span> 1;
        }

        <span class="keywordflow">return</span> 0;
}


<span class="comment">/* List online users. */</span>

<span class="keywordtype">int</span>
gcs_hash ()
{
        <span class="keywordtype">int</span>     i;
        <span class="keywordtype">char</span>    majst[32], minst[32], user[24];
        <span class="keywordtype">char</span>   *lonstr, *supstr, *nixstr;
        <span class="keywordtype">int</span>     baud;

        <span class="keywordflow">if</span> (!<a class="code" href="group__input.html#a4">margc</a>)
                <span class="keywordflow">return</span> 0;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="group__input.html#a4">margc</a> != 1) || !<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/#"</span>))
                <span class="keywordflow">return</span> 0;

        <a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);
        <a class="code" href="group__output.html#a7">prompt</a> (WHOHDR);
        lonstr = <a name="a6"></a><a class="code" href="group__prompts.html#a18">msg_string</a> (WHOLON);
        supstr = <a class="code" href="group__prompts.html#a18">msg_string</a> (WHOSUP);
        nixstr = <a class="code" href="group__prompts.html#a18">msg_string</a> (WHONIX);

        <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__channels.html#a4">chan_count</a>; i++) {
                <span class="keywordtype">char</span>    fname[256], line[256];
                FILE   *fp;

                sprintf (fname, <span class="stringliteral">"%s/.status-%s"</span>,
                         mkfname (CHANDEFDIR), channels[i].ttyname);

                <span class="keywordflow">if</span> ((fp = fopen (fname, <span class="stringliteral">"r"</span>)) == NULL) {
                        <span class="comment">/*int i=errno; */</span>
                        <span class="keywordflow">continue</span>;
                }

                fgets (line, <span class="keyword">sizeof</span> (line), fp);
                fclose (fp);

                <span class="keywordflow">if</span> (sscanf (line, <span class="stringliteral">"%s %s %d %s"</span>, majst, minst, &amp;baud, user) !=
                    4)
                        <span class="keywordflow">continue</span>;

                <span class="keywordflow">if</span> (!strcmp (minst, <span class="stringliteral">"LOGIN"</span>)) {
                        <a class="code" href="group__output.html#a7">prompt</a> (WHOLINE1,
                                channels[i].channel,
                                lonstr, channel_baudstg (baud));

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp (minst, <span class="stringliteral">"USER"</span>)) {
                        <span class="keywordflow">if</span> (!strcmp (user, <span class="stringliteral">"[SIGNUP]"</span>)) {
                                <a class="code" href="group__output.html#a7">prompt</a> (WHOLINE1,
                                        channels[i].channel,
                                        supstr, channel_baudstg (baud));

                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp (user, <span class="stringliteral">"[UNIX]"</span>)) {
                                <a class="code" href="group__output.html#a7">prompt</a> (WHOLINE1,
                                        channels[i].channel,
                                        nixstr, channel_baudstg (baud));

                        } <span class="keywordflow">else</span> {
                                <span class="keyword">struct </span><a name="_a7"></a><a class="code" href="structshmuserrec.html">shmuserrec</a> *ushm = NULL;

                                <span class="keywordflow">if</span> (<a name="a8"></a><a class="code" href="group__useracc.html#a12">usr_insystem</a> (user, !ISYSOP, &amp;ushm)) {
                                        <span class="keywordtype">char</span>    status, invis;

                                        <span class="keywordflow">if</span> (!ushm)
                                                <span class="keywordflow">continue</span>;

                                        <span class="keywordflow">if</span> (ushm-&gt;<a name="a9"></a><a class="code" href="structshmuserrec.html#o1">onl</a>.<a name="a10"></a><a class="code" href="structonlinerec__t.html#o6">flags</a> &amp; <a class="code" href="group__OLF__FLAGS.html#a5">OLF_BUSY</a>)
                                                status = <span class="charliteral">'B'</span>;
                                        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ushm-&gt;<a class="code" href="structshmuserrec.html#o1">onl</a>.<a name="a11"></a><a class="code" href="structonlinerec__t.html#o9">pagestate</a> ==
                                                 <a class="code" href="group__PGS__flags.html#a3">PGS_OFF</a>)
                                                status = <span class="charliteral">'P'</span>;
                                        <span class="keywordflow">else</span>
                                                status = <span class="charliteral">' '</span>;

                                        <span class="keywordflow">if</span> (ushm-&gt;<a class="code" href="structshmuserrec.html#o1">onl</a>.<a class="code" href="structonlinerec__t.html#o6">flags</a> &amp; <a class="code" href="group__OLF__FLAGS.html#a4">OLF_INVISIBLE</a>)
                                                invis = <span class="charliteral">'I'</span>;
                                        <span class="keywordflow">else</span>
                                                invis = <span class="charliteral">' '</span>;
                                        <a class="code" href="group__output.html#a7">prompt</a> (WHOLINE2,
                                                channels[i].channel,
                                                ushm-&gt;<a class="code" href="structshmuserrec.html#o1">onl</a>.<a name="a12"></a><a class="code" href="structonlinerec__t.html#o0">userid</a>,
                                                <a class="code" href="group__channels.html#a11">channel_baudstg</a> (baud),
                                                status,
                                                invis,
                                                ushm-&gt;<a class="code" href="structshmuserrec.html#o1">onl</a>.
                                                descr[(<span class="keywordtype">int</span>) <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.
                                                      language - 1]);
                                }
                                shmdt ((<span class="keywordtype">char</span> *) ushm);
                        }
                }
        }

        <a class="code" href="group__prompts.html#a9">msg_reset</a> ();
        free (lonstr);
        free (supstr);
        free (nixstr);

        <span class="keywordflow">return</span> 1;
}


<span class="comment">/* Print out how many credits a user has. */</span>

<span class="keywordtype">int</span>
gcs_crdavail ()
{
        <span class="keywordflow">if</span> (<a class="code" href="group__input.html#a4">margc</a> == 1 &amp;&amp; <a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/$"</span>)) {
                <span class="keywordtype">char</span>    crdpf[<a class="code" href="config_8h.html#a136">MSGBUFSIZE</a>], minpf[<a class="code" href="config_8h.html#a136">MSGBUFSIZE</a>];

                <a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);
                strcpy (minpf,
                        msg_getunit (MINSING, <a class="code" href="group__user__shm.html#a4">thisuseronl</a>.onlinetime == 1));
                strcpy (crdpf,
                        msg_getunit (CRDSING, <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.credits == 1));
                <a class="code" href="group__output.html#a7">prompt</a> (CRDAVAIL, <a class="code" href="group__user__shm.html#a4">thisuseronl</a>.onlinetime, minpf,
                        <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.credits, crdpf);
                <a class="code" href="group__prompts.html#a9">msg_reset</a> ();
                <span class="keywordflow">return</span> 1;
        }
        <span class="keywordflow">return</span> 0;
}



<span class="comment">/* Print out recent logins. */</span>

<span class="keywordtype">int</span>
gcs_recent ()
{
        FILE   *fp;
        <span class="keywordtype">char</span>    command[256];
        <span class="keywordtype">int</span>     line, day = -1, limit = 0, changes = 0, c;

        <span class="keywordflow">if</span> ((<a class="code" href="group__input.html#a4">margc</a> &gt;= 1) &amp;&amp;
            (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/recent"</span>) || <a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/rc"</span>))) {

                <span class="comment">/* Has the optional argument been specified? */</span>

                <span class="keywordflow">if</span> ((<a class="code" href="group__input.html#a4">margc</a> == 2) &amp;&amp;
                    (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[1], <span class="stringliteral">"help"</span>) || <a class="code" href="group__miscfx.html#a5">sameas</a> (margv[1], <span class="stringliteral">"?"</span>))) {

                        <span class="comment">/* Provide help */</span>

                        <a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);
                        <a class="code" href="group__output.html#a7">prompt</a> (RCNTHLP);
                        <a class="code" href="group__prompts.html#a9">msg_reset</a> ();
                        <a name="a13"></a><a class="code" href="group__input__cnc.html#a2">cnc_end</a> ();
                        <span class="keywordflow">return</span> 1;

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="group__input.html#a4">margc</a> == 1) ||
                           ((<a class="code" href="group__input.html#a4">margc</a> == 2) &amp;&amp; (limit = atoi (margv[1])) != 0)) {

                        <span class="comment">/* List the maximal number of recent users, or an</span>
<span class="comment">                         * optionally specified number (e.g /rc 10 to show the</span>
<span class="comment">                         * last 10 users logged in. */</span>

                        <a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);
                        <a class="code" href="group__output.html#a7">prompt</a> (LSTHDR);
                        sprintf (command, <span class="stringliteral">"tac %s 2&gt;/dev/null"</span>,
                                 mkfname (RECENTFILE));
                        <span class="keywordflow">if</span> ((fp = popen (command, <span class="stringliteral">"r"</span>)) == NULL)
                                <span class="keywordflow">return</span> 0;
                        line = 0;

                        <span class="keywordflow">while</span> (!feof (fp)) {
                                <span class="keywordtype">char</span>    user[32], tty[32], date[32],
                                    tim1[32], tim2[32];
                                <span class="keywordtype">int</span>     delta;
                                time_t  t1, t2;
                                <span class="keyword">struct </span>tm *dt;

                                <span class="keywordflow">if</span> (<a class="code" href="group__format.html#a0">fmt_lastresult</a> == <a class="code" href="group__PAUSE__flags.html#a1">PAUSE_QUIT</a>)
                                        <span class="keywordflow">break</span>;

                                <span class="keywordflow">if</span> (fscanf
                                    (fp, <span class="stringliteral">"%s %s %lx %lx\n"</span>, user, tty, &amp;t1,
                                     &amp;t2) != 4)
                                        <span class="keywordflow">break</span>;

                                dt = localtime (&amp;t1);
                                strcpy (date, strdate (makedate (dt-&gt;tm_mday,
                                                                 dt-&gt;tm_mon +
                                                                 1,
                                                                 1900 +
                                                                 dt-&gt;
                                                                 tm_year)));

                                strcpy (tim1, strtime (maketime (dt-&gt;tm_hour,
                                                                 dt-&gt;tm_min,
                                                                 dt-&gt;tm_sec),
                                                       1));
                                dt = localtime (&amp;t2);
                                strcpy (tim2, strtime (maketime (dt-&gt;tm_hour,
                                                                 dt-&gt;tm_min,
                                                                 dt-&gt;tm_sec),
                                                       1));
                                delta = t2 - t1;
                                line++;
                                <span class="keywordflow">if</span> (limit &amp;&amp; (line &gt; limit))
                                        <span class="keywordflow">break</span>;
                                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!limit) {
                                        <span class="keywordflow">if</span> ((day != -1) &amp;&amp;
                                            (dt-&gt;tm_mday != day))
                                                changes++;
                                        <span class="keywordflow">if</span> (changes &gt;= 2)
                                                <span class="keywordflow">break</span>;
                                }
                                <span class="keywordflow">if</span> ((c = <a name="a14"></a><a class="code" href="group__channels.html#a13">chan_getnum</a> (tty)) &lt; 0)
                                        c = 0;
                                <a class="code" href="group__output.html#a7">prompt</a> (LSTLIN,
                                        user,
                                        c,
                                        date,
                                        tim1,
                                        tim2,
                                        delta / 3600,
                                        (delta % 3600) / 60, delta % 60);
                                day = dt-&gt;tm_mday;
                        }
                        <a class="code" href="group__output.html#a7">prompt</a> (RCFTR, line);
                        <a class="code" href="group__prompts.html#a9">msg_reset</a> ();
                        pclose (fp);
                        <a class="code" href="group__input__cnc.html#a2">cnc_end</a> ();
                        <span class="keywordflow">return</span> 1;

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="group__input.html#a4">margc</a> == 2) &amp;&amp; <a name="a15"></a><a class="code" href="group__useracc.html#a16">usr_uidxref</a> (margv[1], 0)) {

                        <span class="comment">/* A specific user was requested. List that user's</span>
<span class="comment">                         * recent logons. */</span>

                        <span class="keyword">struct </span>stat st;
                        <a name="_a16"></a><a class="code" href="structuseracc__t.html">useracc_t</a> user;

                        sprintf (command, <span class="stringliteral">"%s/%s"</span>, mkfname (RECENTDIR),
                                 margv[1]);
                        <span class="keywordflow">if</span> (stat (command, &amp;st)) {
                                <a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);
                                <a class="code" href="group__output.html#a7">prompt</a> (UNKUSR, margv[1]);
                                <a class="code" href="group__prompts.html#a9">msg_reset</a> ();
                                <a class="code" href="group__input__cnc.html#a2">cnc_end</a> ();
                                <span class="keywordflow">return</span> 1;
                        }
                        <a name="a17"></a><a class="code" href="group__useracc.html#a4">usr_loadaccount</a> (margv[1], &amp;user);
                        <a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);
                        <a class="code" href="group__input__cnc.html#a2">cnc_end</a> ();
                        <a class="code" href="group__output.html#a7">prompt</a> (USRHDR, margv[1], user.connections);
                        sprintf (command, <span class="stringliteral">"tac %s/%s 2&gt;/dev/null"</span>,
                                 mkfname (RECENTDIR), margv[1]);

                        <span class="keywordflow">if</span> ((fp = popen (command, <span class="stringliteral">"r"</span>)) == NULL)
                                <span class="keywordflow">return</span> 0;
                        line = 0;

                        <span class="keywordflow">while</span> (!feof (fp)) {
                                <span class="keywordtype">char</span>    tty[32], date[32], tim1[32], tim2[32];
                                <span class="keywordtype">int</span>     delta;
                                time_t  t1, t2;
                                <span class="keyword">struct </span>tm *dt;

                                <span class="keywordflow">if</span> (<a class="code" href="group__format.html#a0">fmt_lastresult</a> == <a class="code" href="group__PAUSE__flags.html#a1">PAUSE_QUIT</a>)
                                        <span class="keywordflow">break</span>;

                                <span class="keywordflow">if</span> (fscanf (fp, <span class="stringliteral">"%s %lx %lx\n"</span>, tty, &amp;t1, &amp;t2)
                                    != 3)
                                        <span class="keywordflow">break</span>;

                                dt = localtime (&amp;t1);
                                strcpy (date,
                                        strdate (makedate (dt-&gt;tm_mday,
                                                           dt-&gt;tm_mon + 1,
                                                           1900 +
                                                           dt-&gt;tm_year)));

                                strcpy (tim1,
                                        strtime (maketime (dt-&gt;tm_hour,
                                                           dt-&gt;tm_min,
                                                           dt-&gt;tm_sec), 1));

                                dt = localtime (&amp;t2);
                                strcpy (tim2,
                                        strtime (maketime (dt-&gt;tm_hour,
                                                           dt-&gt;tm_min,
                                                           dt-&gt;tm_sec), 1));
                                delta = t2 - t1;
                                <span class="keywordflow">if</span> ((c = <a class="code" href="group__channels.html#a13">chan_getnum</a> (tty)) &lt; 0)
                                        c = 0;

                                <a class="code" href="group__output.html#a7">prompt</a> (USRLIN,
                                        c,
                                        date,
                                        tim1,
                                        tim2,
                                        delta / 3600,
                                        (delta % 3600) / 60, delta % 60);

                                <span class="keywordflow">if</span> (++line &gt;= <a class="code" href="config_8h.html#a138">RECENT_ENTRIES</a>)
                                        <span class="keywordflow">break</span>;
                        }

                        <a class="code" href="group__output.html#a7">prompt</a> (URCFTR);
                        <a class="code" href="group__prompts.html#a9">msg_reset</a> ();
                        pclose (fp);
                        <a class="code" href="group__input__cnc.html#a2">cnc_end</a> ();
                        <span class="keywordflow">return</span> 1;

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__input.html#a4">margc</a> == 2) {

                        <span class="comment">/* We assume the argument is a wrong username */</span>

                        <a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);
                        <a class="code" href="group__output.html#a7">prompt</a> (UNKUSR, margv[1]);
                        <a class="code" href="group__prompts.html#a9">msg_reset</a> ();
                        <a class="code" href="group__input__cnc.html#a2">cnc_end</a> ();
                        <span class="keywordflow">return</span> 1;
                }
        }

        <span class="keywordflow">return</span> 0;
}


<span class="comment">/* Print out the GPL. */</span>

<span class="keywordtype">int</span>
gcs_license ()
{
        <span class="keywordflow">if</span> (!<a class="code" href="group__input.html#a4">margc</a>)
                <span class="keywordflow">return</span> 0;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="group__input.html#a4">margc</a> == 1) &amp;&amp;
                 (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/license"</span>) ||
                  <a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/gpl"</span>))) {
                <span class="keywordtype">char</span>    fname[256];

                strcpy (fname, mkfname (DOCDIR <span class="stringliteral">"/COPYING"</span>));
                <a name="a18"></a><a class="code" href="group__output.html#a12">out_printfile</a> (fname);
                <span class="keywordflow">return</span> 1;

        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="group__input.html#a4">margc</a> == 1) &amp;&amp;
                   (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/rules"</span>) ||
                    <a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/conditions"</span>))) {
                <span class="keywordtype">char</span>    fname[256];

                strcpy (fname, mkfname (DOCDIR <span class="stringliteral">"/RULES"</span>));
                <a class="code" href="group__output.html#a12">out_printfile</a> (fname);
                <span class="keywordflow">return</span> 1;

        }

        <span class="keywordflow">return</span> 0;
}


<span class="keyword">static</span> <span class="keywordtype">int</span>
dopage ()
{
        <span class="comment">/* If the user doesn't have the page override key, a few conditions must</span>
<span class="comment">         * be checked first to ensure the other user's privacy isn't intruded</span>
<span class="comment">         * upon. */</span>

        <span class="keywordflow">if</span> (!<a name="a19"></a><a class="code" href="group__security.html#a3">key_owns</a> (&amp;thisuseracc, <a name="_a20"></a><a class="code" href="structsysvar.html">sysvar</a>-&gt;pgovkey)) {

                <span class="comment">/* The other users allows pages but disallows page</span>
<span class="comment">                 * flooding. Check last page time via the USERPAGED macro. */</span>

                <span class="keywordflow">if</span> (<a class="code" href="group__user__shm.html#a5">othruseronl</a>.pagestate == <a class="code" href="group__PGS__flags.html#a2">PGS_ON</a> &amp;&amp; USERPAGED) {
                        <span class="keywordtype">char</span>    tmp[80];

                        strcpy (tmp, msg_getunit (SEXM,
                                                  <a class="code" href="group__user__shm.html#a3">othruseracc</a>.sex ==
                                                  USX_MALE));
                        <a class="code" href="group__output.html#a7">prompt</a> (PAGL2M, tmp, <a class="code" href="group__user__shm.html#a3">othruseracc</a>.userid,
                                <a class="code" href="group__user__shm.html#a3">othruseracc</a>.pagetime, <a class="code" href="group__prompts.html#a24">msg_getunit</a> (MINSING,
                                                                   <a class="code" href="group__user__shm.html#a3">othruseracc</a>.
                                                                   pagetime ==
                                                                   1));
                        <span class="keywordflow">return</span> 0;

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__user__shm.html#a5">othruseronl</a>.pagestate == <a class="code" href="group__PGS__flags.html#a3">PGS_OFF</a>) {

                        <span class="comment">/* The user disalows pages altogether. */</span>

                        <a class="code" href="group__output.html#a7">prompt</a> (PAGOFF,
                                msg_getunit (SEXM,
                                             <a class="code" href="group__user__shm.html#a3">othruseracc</a>.sex == USX_MALE),
                                <a class="code" href="group__user__shm.html#a3">othruseracc</a>.userid);
                        <span class="keywordflow">return</span> 0;
                }
        }

        <span class="comment">/* Only Sysops can page invisible people. */</span>

        <span class="keywordflow">if</span> (!(<a class="code" href="group__user__shm.html#a5">othruseronl</a>.flags &amp; <a class="code" href="group__OLF__FLAGS.html#a4">OLF_INVISIBLE</a>) || ISYSOP) {
                <span class="keywordtype">char</span>   *pgfrom =
                    (<span class="keywordtype">char</span> *) &amp;<a class="code" href="group__user__shm.html#a4">thisuseronl</a>.descr[(<span class="keywordtype">int</span>) <a class="code" href="group__user__shm.html#a3">othruseracc</a>.language -
                                                1];
                <span class="keywordtype">char</span>    injbuf[<a class="code" href="config_8h.html#a136">MSGBUFSIZE</a>];

                <span class="keywordflow">if</span> (!<a name="a21"></a><a class="code" href="group__security.html#a0">hassysaxs</a> (&amp;othruseracc, USY_MASTERKEY)
                    &amp;&amp; (<a class="code" href="group__user__shm.html#a4">thisuseronl</a>.flags &amp; <a class="code" href="group__OLF__FLAGS.html#a4">OLF_INVISIBLE</a>)) {

                        <span class="comment">/* Only sysops can *page* while invisible. */</span>

                        <a class="code" href="group__output.html#a7">prompt</a> (URINVS);
                        <span class="keywordflow">return</span> 0;

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__input.html#a4">margc</a> == 2) {
                        <a name="a22"></a><a class="code" href="group__output.html#a9">sprompt_other</a> (othrshm, injbuf,
                                       <a class="code" href="group__user__shm.html#a5">othruseronl</a>.
                                       flags &amp; OLF_BUSY ? PAGMSG1 : PAGMSG2,
                                       <a class="code" href="group__prompts.html#a24">msg_getunit</a> (SEXM,
                                                    <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.sex ==
                                                    USX_MALE),
                                       <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.userid, pgfrom);
                } <span class="keywordflow">else</span> {
                        <a name="a23"></a><a class="code" href="group__inp__midlevel.html#a3">inp_raw</a> ();
                        <a class="code" href="group__output.html#a9">sprompt_other</a> (othrshm, injbuf,
                                       <a class="code" href="group__user__shm.html#a5">othruseronl</a>.
                                       flags &amp; OLF_BUSY ? PAGNOT1 : PAGNOT2,
                                       <a class="code" href="group__prompts.html#a24">msg_getunit</a> (SEXM,
                                                    <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.sex ==
                                                    USX_MALE),
                                       <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.userid, pgfrom, margv[2]);
                }

                <span class="comment">/* Is the other user non-busy and in a module that supports</span>
<span class="comment">                 * paging at this point? */</span>

                <span class="keywordflow">if</span> (!(<a class="code" href="group__user__shm.html#a5">othruseronl</a>.flags &amp; <a class="code" href="group__OLF__FLAGS.html#a5">OLF_BUSY</a>)) {
                        <a class="code" href="group__output.html#a7">prompt</a> (PAGEOK,
                                msg_getunit (ACKM,
                                             <a class="code" href="group__user__shm.html#a3">othruseracc</a>.sex == USX_MALE),
                                <a class="code" href="group__user__shm.html#a3">othruseracc</a>.userid);
                        <a name="a24"></a><a class="code" href="group__useracc.html#a14">usr_injoth</a> (&amp;othruseronl, injbuf, 0);
                        <a class="code" href="group__user__shm.html#a5">othruseronl</a>.lastpage = <a class="code" href="group__user__shm.html#a5">othruseronl</a>.onlinetime;
                        <span class="keywordflow">return</span> 1;

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__user__shm.html#a5">othruseronl</a>.pagestate == <a class="code" href="group__PGS__flags.html#a0">PGS_STORE</a> ||
                           <a class="code" href="group__security.html#a3">key_owns</a> (&amp;thisuseracc, <a class="code" href="structsysvar.html">sysvar</a>-&gt;pgovkey)) {

                        <span class="comment">/* Store the page for later delivery. */</span>

                        <span class="keywordtype">char</span>    ack[<a class="code" href="config_8h.html#a136">MSGBUFSIZE</a>];

                        <a class="code" href="group__output.html#a7">prompt</a> (PAGNPST,
                                msg_getunit (NOMM,
                                             <a class="code" href="group__user__shm.html#a3">othruseracc</a>.sex == USX_MALE),
                                <a class="code" href="group__user__shm.html#a3">othruseracc</a>.userid);

                        <a name="a25"></a><a class="code" href="group__output.html#a8">sprompt</a> (ack, PAGSTOK,
                                 msg_getunit (SEXM,
                                              <a class="code" href="group__user__shm.html#a3">othruseracc</a>.sex == USX_MALE),
                                 <a class="code" href="group__user__shm.html#a3">othruseracc</a>.userid);

                        <a name="a26"></a><a class="code" href="group__useracc.html#a15">usr_injoth_ack</a> (&amp;othruseronl, injbuf, ack, 1);
                        <a class="code" href="group__user__shm.html#a5">othruseronl</a>.lastpage = <a class="code" href="group__user__shm.html#a5">othruseronl</a>.onlinetime;
                        <span class="keywordflow">return</span> 1;

                } <span class="keywordflow">else</span>
                        <a class="code" href="group__output.html#a7">prompt</a> (PAGNPS,
                                msg_getunit (ACKM,
                                             <a class="code" href="group__user__shm.html#a3">othruseracc</a>.sex == USX_MALE),
                                <a class="code" href="group__user__shm.html#a3">othruseracc</a>.userid);
        }
        <span class="keywordflow">return</span> 0;
}


<span class="comment">/* Page another user and set our own paging preferences. */</span>

<span class="keywordtype">int</span>
gcs_page ()
{
        <span class="keywordflow">if</span> (<a class="code" href="group__input.html#a4">margc</a> &amp;&amp; <a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/p"</span>)) {
                <a class="code" href="group__prompts.html#a8">msg_set</a> (msg_sys);

                <span class="keywordflow">if</span> (!<a class="code" href="group__security.html#a3">key_owns</a> (&amp;thisuseracc, <a class="code" href="structsysvar.html">sysvar</a>-&gt;pagekey)) {

                        <span class="comment">/* The user doesn't have permissions to page. */</span>

                        <a class="code" href="group__output.html#a7">prompt</a> (CANTPG);

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__input.html#a4">margc</a> == 1) {

                        <span class="comment">/* Produce a help string. */</span>

                        <a class="code" href="group__output.html#a7">prompt</a> (PAGFMT);

                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a name="a27"></a><a class="code" href="group__useracc.html#a13">usr_insys</a> (margv[1], !ISYSOP)) {

                        <span class="comment">/* Set preferences. */</span>

                        <span class="keywordflow">if</span> (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[1], <span class="stringliteral">"on"</span>)) {
                                <a class="code" href="group__user__shm.html#a4">thisuseronl</a>.pagestate = <a class="code" href="group__PGS__flags.html#a2">PGS_ON</a>;
                                <a class="code" href="group__output.html#a7">prompt</a> (PAGTON,
                                        <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.pagetime,
                                        <a class="code" href="group__prompts.html#a24">msg_getunit</a> (MINSING,
                                                     <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.pagetime ==
                                                     1));

                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[1], <span class="stringliteral">"off"</span>)) {
                                <a class="code" href="group__user__shm.html#a4">thisuseronl</a>.pagestate = <a class="code" href="group__PGS__flags.html#a3">PGS_OFF</a>;
                                <a class="code" href="group__output.html#a7">prompt</a> (PAGTOF);

                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[1], <span class="stringliteral">"ok"</span>)) {
                                <a class="code" href="group__user__shm.html#a4">thisuseronl</a>.pagestate = <a class="code" href="group__PGS__flags.html#a1">PGS_OK</a>;
                                <a class="code" href="group__output.html#a7">prompt</a> (PAGTOK);

                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[1], <span class="stringliteral">"store"</span>)) {
                                <a class="code" href="group__user__shm.html#a4">thisuseronl</a>.pagestate = <a class="code" href="group__PGS__flags.html#a0">PGS_STORE</a>;
                                <a class="code" href="group__output.html#a7">prompt</a> (PAGTST);

                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[1], SYSOP)) {
                                <a class="code" href="group__output.html#a7">prompt</a> (PGSYSOP);
                                <a class="code" href="group__user__shm.html#a4">thisuseronl</a>.lastconsolepage = time (NULL);

                        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[1], <span class="stringliteral">"all"</span>) &amp;&amp;
                                   (<a class="code" href="group__security.html#a3">key_owns</a> (&amp;thisuseracc, <a class="code" href="structsysvar.html">sysvar</a>-&gt;pallkey)))
                        {

                                <span class="comment">/* Paging all users (if this user has permission). */</span>

                                <span class="keywordtype">int</span>     i, count = 0;
                                <a name="_a28"></a><a class="code" href="structchannel__status__t.html">channel_status_t</a> status;

                                <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__channels.html#a4">chan_count</a>; i++) {
                                        <span class="keywordflow">if</span> (<a class="code" href="group__channels.html#a5">channel_getstatus</a>
                                            (<a class="code" href="group__channels.html#a2">channels</a>[i].<a name="a29"></a><a class="code" href="structchanneldef.html#o0">ttyname</a>, &amp;status) &lt; 0)
                                                <span class="keywordflow">continue</span>;

                                        <span class="keywordflow">if</span> (status.<a name="a30"></a><a class="code" href="structchannel__status__t.html#o1">result</a> == <a class="code" href="group__LSR__flags.html#a5">LSR_USER</a>) {
                                                <span class="keywordflow">if</span> (<a class="code" href="group__miscfx.html#a5">sameas</a> (status.<a name="a31"></a><a class="code" href="structchannel__status__t.html#o3">user</a>,
                                                            <a class="code" href="group__user__shm.html#a2">thisuseracc</a>.
                                                            userid))
                                                        <span class="keywordflow">continue</span>;

                                                <span class="keywordflow">if</span> (<a class="code" href="group__useracc.html#a13">usr_insys</a>
                                                    (status.<a class="code" href="structchannel__status__t.html#o3">user</a>, !ISYSOP)) {
                                                        <span class="keywordflow">if</span> (!<a class="code" href="group__user__shm.html#a1">othrshm</a>)
                                                                <span class="keywordflow">continue</span>;
                                                        count += dopage ();
                                                }
                                        }
                                }

                                <span class="keywordflow">if</span> (!count)
                                        <a class="code" href="group__output.html#a7">prompt</a> (PALLNC);

                        } <span class="keywordflow">else</span> {

                                <span class="comment">/* Page a single user. */</span>

                                <span class="keywordtype">int</span>     i, count = 0;
                                <span class="keywordtype">char</span>    userid[25];
                                <a class="code" href="structchannel__status__t.html">channel_status_t</a> status;

                                <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group__channels.html#a4">chan_count</a>; i++) {
                                        <span class="keywordflow">if</span> (<a class="code" href="group__channels.html#a5">channel_getstatus</a>
                                            (<a class="code" href="group__channels.html#a2">channels</a>[i].<a class="code" href="structchanneldef.html#o0">ttyname</a>, &amp;status) &lt; 0)
                                                <span class="keywordflow">continue</span>;

                                        <span class="keywordflow">if</span> (status.<a class="code" href="structchannel__status__t.html#o1">result</a> == <a class="code" href="group__LSR__flags.html#a5">LSR_USER</a>) {
                                                <span class="keywordflow">if</span> (<a class="code" href="group__useracc.html#a13">usr_insys</a>
                                                    (status.<a class="code" href="structchannel__status__t.html#o3">user</a>, !ISYSOP)) {
                                                        <span class="keywordflow">if</span> (!<a class="code" href="group__user__shm.html#a1">othrshm</a>)
                                                                <span class="keywordflow">continue</span>;

                                                        <span class="keywordflow">if</span> (<a class="code" href="group__user__shm.html#a5">othruseronl</a>.
                                                            flags &amp;
                                                            <a class="code" href="group__OLF__FLAGS.html#a4">OLF_INVISIBLE</a> &amp;&amp;
                                                            (!ISYSOP))
                                                                <span class="keywordflow">continue</span>;

                                                        <span class="keywordflow">if</span> (<a name="a32"></a><a class="code" href="group__miscfx.html#a4">sameto</a> (margv[1],
                                                                    <a class="code" href="group__user__shm.html#a5">othruseronl</a>.
                                                                    userid)) {
                                                                count++;
                                                                strcpy (userid,
                                                                        <a class="code" href="group__user__shm.html#a5">othruseronl</a>.
                                                                        userid);
                                                        }
                                                }
                                        }
                                }

                                <span class="keywordflow">if</span> (!count) {
                                        <a class="code" href="group__output.html#a7">prompt</a> (PAGNON, margv[1]);
                                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (count &gt; 1) {
                                        <a class="code" href="group__output.html#a7">prompt</a> (PAGMOM, margv[1]);
                                } <span class="keywordflow">else</span> {
                                        <a class="code" href="group__useracc.html#a13">usr_insys</a> (userid, !ISYSOP);
                                        dopage ();
                                }
                        }
                } <span class="keywordflow">else</span>
                        dopage ();

                <a class="code" href="group__prompts.html#a9">msg_reset</a> ();
                <span class="keywordflow">return</span> 1;
        }

        <span class="keywordflow">return</span> 0;
}


<span class="comment">/* Toggle bot mode manually. */</span>

<span class="keyword">static</span> <span class="keywordtype">int</span>
gcs_bot ()
{
        <span class="keywordflow">if</span> (!<a class="code" href="group__input.html#a4">margc</a>)
                <span class="keywordflow">return</span> 0;
        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__input.html#a4">margc</a> == 1 &amp;&amp; (<a class="code" href="group__miscfx.html#a5">sameas</a> (margv[0], <span class="stringliteral">"/_bot"</span>))) {
                <a class="code" href="group__user__shm.html#a4">thisuseronl</a>.flags ^= <a class="code" href="group__OLF__FLAGS.html#a23">OLF_ISBOT</a>;
                <span class="keywordflow">if</span> (<a class="code" href="group__user__shm.html#a4">thisuseronl</a>.flags &amp; <a class="code" href="group__OLF__FLAGS.html#a23">OLF_ISBOT</a>) {
                        <a name="a33"></a><a class="code" href="group__toplevel.html#a12">mod_setbot</a> (1);
                        <a class="code" href="group__output.html#a10">print</a>
                            (<span class="stringliteral">"290 Bot mode active.\n290 Enter /_bot to turn off.\n"</span>);
                        <a class="code" href="group__output.html#a10">print</a>
                            (<span class="stringliteral">"290 If you're not a bot, things will get VERY confusing now.\n"</span>);
                } <span class="keywordflow">else</span> {
                        <a class="code" href="group__toplevel.html#a12">mod_setbot</a> (0);
                        <a name="a34"></a><a class="code" href="group__output.html#a10">print</a> (<span class="stringliteral">"290 Bot mode off.\n"</span>);
                }
                <span class="keywordflow">return</span> 1;
        } <span class="keywordflow">else</span>
                <span class="keywordflow">return</span> 0;
}



<span class="comment">/* Main GCS entry point. This is mandatory. */</span>

<span class="keywordtype">int</span>
__INIT_GCS__ ()
{
        <span class="keywordflow">if</span> (gcs_hash ())
                <span class="keywordflow">return</span> 1;
        <span class="keywordflow">if</span> (gcs_page ())
                <span class="keywordflow">return</span> 1;
        <span class="keywordflow">if</span> (gcs_recent ())
                <span class="keywordflow">return</span> 1;
        <span class="keywordflow">if</span> (gcs_time ())
                <span class="keywordflow">return</span> 1;
        <span class="keywordflow">if</span> (gcs_crdavail ())
                <span class="keywordflow">return</span> 1;
        <span class="keywordflow">if</span> (gcs_license ())
                <span class="keywordflow">return</span> 1;
        <span class="keywordflow">if</span> (gcs_bot ())
                <span class="keywordflow">return</span> 1;

        <span class="keywordflow">return</span> 0;
}
</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Sat Oct 4 21:56:08 2003 for Megistos API by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.2 </small></address>
</body>
</html>
