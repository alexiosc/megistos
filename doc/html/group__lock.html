<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Megistos API: Resource Locking and Serialisation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>Resource Locking and Serialisation</h1>This header defines an interface to the locking features of the BBS.  
<a href="#_details">More...</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Modules</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>group &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="group__LKR__flags.html">Lock result codes (LKR_x)</a></td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Resource locking result codes. <br><br></td></tr>

<p>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="group__lock.html#ga4">BBSLOCKD_SOCKET</a>&nbsp;&nbsp;&nbsp;mkfname(BBSETCDIR"/lock.socket")</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="group__lock.html#ga0">lock_place</a> (const char *name, const char *info)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Place a lock.  <a href="#ga0"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="group__lock.html#ga1">lock_check</a> (const char *name, char *info)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check if a lock exists.  <a href="#ga1"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="group__lock.html#ga2">lock_rm</a> (const char *name)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove a lock.  <a href="#ga2"></a><br><br></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="group__lock.html#ga3">lock_wait</a> (const char *name, int delay)</td></tr>

<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Waits for a lock.  <a href="#ga3"></a><br><br></td></tr>
</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
This header defines an interface to the locking features of the BBS. 
<p>
Locks are implemented with the aid of the lock daemon, lockd, which listens to commands on a socket.<p>
Lockd requests are strings sent to the daemon's socket. They look like this:<p>
<pre><div class="fragment">
MAKE foo 42 bar  Creates lock "foo" with info "bar" for PID 42
CHCK foo 42      Checks for the presence of lock "foo" (we're PID 42)
KILL foo 42      Removes lock "foo" on behalf of process with PID 42
</div></pre><p>
Results are integers in decimal (matching the <code>LKR_</code> constants below) followed by a string. A positive result code denotes the PID of a process holding the lock. In this case, the result code is followed by a string containing the <code>info</code> field of the lock. Negative result codes denote error conditions.<p>
All this is slightly academic, though. The details of the transactions with the daemon are hidden from the user. <hr><h2>Define Documentation</h2>
<a class="anchor" name="ga4" doxytag="lock.h::BBSLOCKD_SOCKET" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BBSLOCKD_SOCKET&nbsp;&nbsp;&nbsp;mkfname(BBSETCDIR"/lock.socket")          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="lock_8h-source.html#l00102">102</a> of file <a class="el" href="lock_8h-source.html">lock.h</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="ga1" doxytag="lock.h::lock_check" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int lock_check           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>char *&nbsp;</td>
          <td class="mdname" nowrap> <em>info</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Check if a lock exists. 
<p>
Checks for the existence of a lock. If the lock does not exist, { LKR_OK} will be returned. If the lock exists, a PID (an integer greater than zero) will be returned. Please refer to the documentation for the { LKR_x} constants for more information.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>name</em>&nbsp;</td><td>the name of the resource to be checked (filename of the lock, too).</td></tr>
    <tr><td></td><td valign=top><em>info</em>&nbsp;</td><td>if the lock exists, its <code>info</code> field is copied to the supplied string.</td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>One of the <code>LKR_x</code> result codes. </dd></dl>
    </td>
  </tr>
</table>
<a class="anchor" name="ga0" doxytag="lock.h::lock_place" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int lock_place           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>info</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Place a lock. 
<p>
Registers a resource lock. The lock will first be checked to make sure you have permission to place it. Permission is given if the lock:<p>
{itemize}  does not exist;  exists and is your own; or  exists and is stale (i.e. belongs to a dead process). {itemize}<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>name</em>&nbsp;</td><td>the name of the resource to be locked (filename of the lock, too).</td></tr>
    <tr><td></td><td valign=top><em>info</em>&nbsp;</td><td>a short description of the lock. This is for your benefit only, so that processes competing for a lock will know why a lock is in place.</td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>One of the <code>LKR_x</code> result codes. </dd></dl>
    </td>
  </tr>
</table>
<a class="anchor" name="ga2" doxytag="lock.h::lock_rm" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int lock_rm           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">const char *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>name</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Remove a lock. 
<p>
Removes the named lock.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>name</em>&nbsp;</td><td>the name of the lock to be removed.</td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>One of the <code>LKR_x} result codes. { LKR_ERROR</code> denotes an error with <code>unlink()</code>, in which case the error will be left in { errno} for your delectation. </dd></dl>
    </td>
  </tr>
</table>
<a class="anchor" name="ga3" doxytag="lock.h::lock_wait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int lock_wait           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">const char *&nbsp;</td>
          <td class="mdname" nowrap> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>delay</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Waits for a lock. 
<p>
Waits for a resource lock to become available. This function blocks, repeatedly checking if the specified lock has been released.<p>
<dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td></td><td valign=top><em>name</em>&nbsp;</td><td>the name of the lock to check.</td></tr>
    <tr><td></td><td valign=top><em>delay</em>&nbsp;</td><td>the maximum time to wait in seconds.</td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>One of the <code>LKR_x</code> result codes representing the state of the lock when the process exist. <code>LKR_TIMEOUT</code> is reported when the time specified by <code>delay</code> expired and the lock was still unavailable. </dd></dl>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Thu Jul 15 16:04:03 2004 for Megistos API by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
